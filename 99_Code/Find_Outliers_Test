
rm(list=ls(all=TRUE))

library(data.table)

loop.species.function <- function(choose_species, common_sample1_df, common_sample2_df){
  
  TEMP_res <- data.frame(array(NA, dim = c(1,11), dimnames = list(c(),c("Deer","EnvA","EnvB","Species","Scaffolds","SNPs","SNPs.per.Scaffold","Max.Freq","Quantile.75","Mean.Freq","Pr.SNP.over.75"))))
  
  TEMP_res[,1] <- DEER
  TEMP_res[,2] <- envA
  TEMP_res[,3] <- envB
  
  TEMP_res[,4] <- choose_species
  
  
  single_species_sample1 <- common_sample1_df[common_sample1_df$Species==choose_species,]
  single_species_sample2 <- common_sample2_df[common_sample2_df$Species==choose_species,]
  
  single_species_sample1$Scaffold2 <- gsub(paste0(unique(single_species_sample1$Species),"_"),"",single_species_sample1$Scaffold2)
  single_species_sample2$Scaffold2 <- gsub(paste0(unique(single_species_sample2$Species),"_"),"",single_species_sample2$Scaffold2)
  
  single_species_sample1$Chrom_POS <- paste0(single_species_sample1$Scaffold2,"_POS_",single_species_sample1$position)
  single_species_sample2$Chrom_POS <- paste0(single_species_sample2$Scaffold2,"_POS_",single_species_sample2$position)
  
  
  merge_sample_df <- merge(single_species_sample1, single_species_sample2, by="Chrom_POS", all = TRUE)
  
  merge_sample_df[is.na(merge_sample_df$ref_freq.x),"ref_freq.x"] <- 1
  merge_sample_df[is.na(merge_sample_df$ref_freq.y),"ref_freq.y"] <- 1
  
  merge_sample_df[is.na(merge_sample_df$var_freq.x),"var_freq.x"] <- 0
  merge_sample_df[is.na(merge_sample_df$var_freq.y),"var_freq.y"] <- 0
  
  
  merge_sample_df[is.na(merge_sample_df$scaffold.x),"scaffold.x"] <- merge_sample_df[is.na(merge_sample_df$scaffold.x),"scaffold.y"]
  merge_sample_df[is.na(merge_sample_df$scaffold.y),"scaffold.y"] <- merge_sample_df[is.na(merge_sample_df$scaffold.y),"scaffold.x"]
  
  merge_sample_df[is.na(merge_sample_df$position.x),"position.x"] <- merge_sample_df[is.na(merge_sample_df$position.x),"position.y"]
  merge_sample_df[is.na(merge_sample_df$position.y),"position.y"] <- merge_sample_df[is.na(merge_sample_df$position.y),"position.x"]
  
  merge_sample_df[is.na(merge_sample_df$Species.x),"Species.x"] <- merge_sample_df[is.na(merge_sample_df$Species.x),"Species.y"]
  merge_sample_df[is.na(merge_sample_df$Species.y),"Species.y"] <- merge_sample_df[is.na(merge_sample_df$Species.y),"Species.x"]
  
  merge_sample_df[is.na(merge_sample_df$Scaffold2.x),"Scaffold2.x"] <- merge_sample_df[is.na(merge_sample_df$Scaffold2.x),"Scaffold2.y"]
  merge_sample_df[is.na(merge_sample_df$Scaffold2.y),"Scaffold2.y"] <- merge_sample_df[is.na(merge_sample_df$Scaffold2.y),"Scaffold2.x"]
  
  
  if(length(unique(merge_sample_df$Scaffold2.x)) != length(unique(merge_sample_df$Scaffold2.y))){message("ERROR");break}
  
  TEMP_res[,5] <- length(unique(merge_sample_df$Scaffold2.x))
  
  
  merge_sample_df$Freq_Diff <- merge_sample_df$ref_freq.y - merge_sample_df$ref_freq.x
  
  abs_freq_diff <- abs(merge_sample_df$Freq_Diff)
  

  TEMP_res[,6] <- length(abs_freq_diff)
  TEMP_res[,7] <- round((length(abs_freq_diff)/TEMP_res[,5]),1)
  TEMP_res[,8] <- round(max(abs_freq_diff),3)
  TEMP_res[,9] <- round(quantile(abs_freq_diff, 0.75),3)
  TEMP_res[,10] <- round(mean(abs_freq_diff),3)
  TEMP_res[,11] <- round((sum(abs_freq_diff>=0.75)/length(abs_freq_diff)),3)

  return(TEMP_res)
  
}

setwd("~/Dropbox/My Mac (Russs-MacBook-Air.local)/Desktop/BERN/RESULTS/DEER/14_InStrain")


num_common_species <- data.frame(array(NA, dim = c(0,6), dimnames = list(c(),c("Deer","EnvA","EnvB","EnvA.Species","EnvB.Species","Common.Species"))))
common_species_TEMP <- data.frame(array(NA, dim = c(1,6), dimnames = list(c(),c("Deer","EnvA","EnvB","EnvA.Species","EnvB.Species","Common.Species"))))

deer_results<-NULL
master_results<-NULL

for(DEER in 1:1){
  
  # for(envA in 1:10){
  # for(envB in 1:10){  
  
  for(envA in c(1,2,10)){
  for(envB in c(1,2,10)){  
      
      
    if(envA>=envB){next}
    
    
    file1 <- paste0(DEER,"_",envA,"_InStrain_SNVs.tsv")
    file2 <- paste0(DEER,"_",envB,"_InStrain_SNVs.tsv")
    
    sample11 <- data.frame(fread(file1, header=T, stringsAsFactors = F, sep = "\t"))
    sample22 <- data.frame(fread(file2, header=T, stringsAsFactors = F, sep = "\t"))
    
    sample1 <- sample11[colnames(sample11) %in% c("scaffold","position","ref_freq","var_freq")]
    sample2 <- sample22[colnames(sample22) %in% c("scaffold","position","ref_freq","var_freq")]
    
    
    sample1$Species <- gsub("_NODE.*","",sample1$scaffold)
    sample2$Species <- gsub("_NODE.*","",sample2$scaffold)
    
    sample1$Scaffold2 <- gsub("_length.*","",sample1$scaffold)
    sample2$Scaffold2 <- gsub("_length.*","",sample2$scaffold)
    
    
    sample1_species <- unique(sample1$Species)
    sample2_species <- unique(sample2$Species)
    
    common_species <- c(sample1_species, sample2_species)[duplicated(c(sample1_species, sample2_species))]
    
    common_species_TEMP[,1] <- DEER
    common_species_TEMP[,2] <- envA
    common_species_TEMP[,3] <- envB
    common_species_TEMP[,4] <- length(sample1_species)
    common_species_TEMP[,5] <- length(sample2_species)
    common_species_TEMP[,6] <- length(common_species)
    num_common_species <- rbind(num_common_species, common_species_TEMP)
    
    
    common_sample1_data <- sample1[sample1$Species %in% common_species, ]
    common_sample2_data <- sample2[sample2$Species %in% common_species, ]
    
    
    results1 <- lapply(common_species, FUN=loop.species.function, common_sample1_df=common_sample1_data, common_sample2_df=common_sample2_data)
    results2 <- as.data.frame(do.call(rbind, results1))
    
    if(envA==1 & envB==2){ deer_results <- results2 } else { deer_results <- rbind(deer_results,results2) }
    
  } # env
  } # env
  
  if(DEER==1){ master_results <- deer_results } else { master_results <- rbind(master_results, deer_results) }
  
} # deer
